!function(r){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=r();else if("function"==typeof define&&define.amd)define([],r);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).diffsync=r()}}(function(){return function(){return function r(f,s,i){function p(h,l){if(!s[h]){if(!f[h]){var a="function"==typeof require&&require;if(!l&&a)return a(h,!0);if(u)return u(h,!0);var y=new Error("Cannot find module '"+h+"'");throw y.code="MODULE_NOT_FOUND",y}var w=s[h]={exports:{}};f[h][0].call(w.exports,function(r){return p(f[h][1][r]||r)},w,w.exports,r,f,s,i)}return s[h].exports}for(var u="function"==typeof require&&require,h=0;h<i.length;h++)p(i[h]);return p}}()({1:[function(r,f,s){var i=Object.create||function(r){var f=function(){};return f.prototype=r,new f},p=Object.keys||function(r){var f=[];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&f.push(s);return s},u=Function.prototype.bind||function(r){var f=this;return function(){return f.apply(r,arguments)}};function h(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=i(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}f.exports=h,h.EventEmitter=h,h.prototype._events=void 0,h.prototype._maxListeners=void 0;var l,a=10;try{var y={};Object.defineProperty&&Object.defineProperty(y,"x",{value:0}),l=0===y.x}catch(r){l=!1}function w(r){return void 0===r._maxListeners?h.defaultMaxListeners:r._maxListeners}function b(r,f,s,p){var u,h,l;if("function"!=typeof s)throw new TypeError('"listener" argument must be a function');if((h=r._events)?(h.newListener&&(r.emit("newListener",f,s.listener?s.listener:s),h=r._events),l=h[f]):(h=r._events=i(null),r._eventsCount=0),l){if("function"==typeof l?l=h[f]=p?[s,l]:[l,s]:p?l.unshift(s):l.push(s),!l.warned&&(u=w(r))&&u>0&&l.length>u){l.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+l.length+' "'+String(f)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');a.name="MaxListenersExceededWarning",a.emitter=r,a.type=f,a.count=l.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",a.name,a.message)}}else l=h[f]=s,++r._eventsCount;return r}function j(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var r=new Array(arguments.length),f=0;f<r.length;++f)r[f]=arguments[f];this.listener.apply(this.target,r)}}function _(r,f,s){var i={fired:!1,wrapFn:void 0,target:r,type:f,listener:s},p=u.call(j,i);return p.listener=s,i.wrapFn=p,p}function g(r,f,s){var i=r._events;if(!i)return[];var p=i[f];return p?"function"==typeof p?s?[p.listener||p]:[p]:s?function(r){for(var f=new Array(r.length),s=0;s<f.length;++s)f[s]=r[s].listener||r[s];return f}(p):N(p,p.length):[]}function E(r){var f=this._events;if(f){var s=f[r];if("function"==typeof s)return 1;if(s)return s.length}return 0}function N(r,f){for(var s=new Array(f),i=0;i<f;++i)s[i]=r[i];return s}l?Object.defineProperty(h,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(r){if("number"!=typeof r||r<0||r!=r)throw new TypeError('"defaultMaxListeners" must be a positive number');a=r}}):h.defaultMaxListeners=a,h.prototype.setMaxListeners=function(r){if("number"!=typeof r||r<0||isNaN(r))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=r,this},h.prototype.getMaxListeners=function(){return w(this)},h.prototype.emit=function(r){var f,s,i,p,u,h,l="error"===r;if(h=this._events)l=l&&null==h.error;else if(!l)return!1;if(l){if(arguments.length>1&&(f=arguments[1]),f instanceof Error)throw f;var a=new Error('Unhandled "error" event. ('+f+")");throw a.context=f,a}if(!(s=h[r]))return!1;var y="function"==typeof s;switch(i=arguments.length){case 1:!function(r,f,s){if(f)r.call(s);else for(var i=r.length,p=N(r,i),u=0;u<i;++u)p[u].call(s)}(s,y,this);break;case 2:!function(r,f,s,i){if(f)r.call(s,i);else for(var p=r.length,u=N(r,p),h=0;h<p;++h)u[h].call(s,i)}(s,y,this,arguments[1]);break;case 3:!function(r,f,s,i,p){if(f)r.call(s,i,p);else for(var u=r.length,h=N(r,u),l=0;l<u;++l)h[l].call(s,i,p)}(s,y,this,arguments[1],arguments[2]);break;case 4:!function(r,f,s,i,p,u){if(f)r.call(s,i,p,u);else for(var h=r.length,l=N(r,h),a=0;a<h;++a)l[a].call(s,i,p,u)}(s,y,this,arguments[1],arguments[2],arguments[3]);break;default:for(p=new Array(i-1),u=1;u<i;u++)p[u-1]=arguments[u];!function(r,f,s,i){if(f)r.apply(s,i);else for(var p=r.length,u=N(r,p),h=0;h<p;++h)u[h].apply(s,i)}(s,y,this,p)}return!0},h.prototype.addListener=function(r,f){return b(this,r,f,!1)},h.prototype.on=h.prototype.addListener,h.prototype.prependListener=function(r,f){return b(this,r,f,!0)},h.prototype.once=function(r,f){if("function"!=typeof f)throw new TypeError('"listener" argument must be a function');return this.on(r,_(this,r,f)),this},h.prototype.prependOnceListener=function(r,f){if("function"!=typeof f)throw new TypeError('"listener" argument must be a function');return this.prependListener(r,_(this,r,f)),this},h.prototype.removeListener=function(r,f){var s,p,u,h,l;if("function"!=typeof f)throw new TypeError('"listener" argument must be a function');if(!(p=this._events))return this;if(!(s=p[r]))return this;if(s===f||s.listener===f)0==--this._eventsCount?this._events=i(null):(delete p[r],p.removeListener&&this.emit("removeListener",r,s.listener||f));else if("function"!=typeof s){for(u=-1,h=s.length-1;h>=0;h--)if(s[h]===f||s[h].listener===f){l=s[h].listener,u=h;break}if(u<0)return this;0===u?s.shift():function(r,f){for(var s=f,i=s+1,p=r.length;i<p;s+=1,i+=1)r[s]=r[i];r.pop()}(s,u),1===s.length&&(p[r]=s[0]),p.removeListener&&this.emit("removeListener",r,l||f)}return this},h.prototype.removeAllListeners=function(r){var f,s,u;if(!(s=this._events))return this;if(!s.removeListener)return 0===arguments.length?(this._events=i(null),this._eventsCount=0):s[r]&&(0==--this._eventsCount?this._events=i(null):delete s[r]),this;if(0===arguments.length){var h,l=p(s);for(u=0;u<l.length;++u)"removeListener"!==(h=l[u])&&this.removeAllListeners(h);return this.removeAllListeners("removeListener"),this._events=i(null),this._eventsCount=0,this}if("function"==typeof(f=s[r]))this.removeListener(r,f);else if(f)for(u=f.length-1;u>=0;u--)this.removeListener(r,f[u]);return this},h.prototype.listeners=function(r){return g(this,r,!0)},h.prototype.rawListeners=function(r){return g(this,r,!1)},h.listenerCount=function(r,f){return"function"==typeof r.listenerCount?r.listenerCount(f):E.call(r,f)},h.prototype.listenerCount=E,h.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],2:[function(r,f,s){f.exports={Client:r("./src/client"),Server:r("./src/server"),COMMANDS:r("./src/commands"),InMemoryDataAdapter:r("./src/adapter")}},{"./src/adapter":37,"./src/client":38,"./src/commands":39,"./src/server":40}],3:[function(r,f,s){var i=r("../pipe").Pipe,p=function(){};p.prototype.setResult=function(r){return this.result=r,this.hasResult=!0,this},p.prototype.exit=function(){return this.exiting=!0,this},p.prototype.switchTo=function(r,f){return"string"==typeof r||r instanceof i?this.nextPipe=r:(this.next=r,f&&(this.nextPipe=f)),this},p.prototype.push=function(r,f){return r.parent=this,void 0!==f&&(r.childName=f),r.root=this.root||this,r.options=r.options||this.options,this.children?(this.children[this.children.length-1].next=r,this.children.push(r)):(this.children=[r],this.nextAfterChildren=this.next||null,this.next=r),r.next=this,this},s.Context=p},{"../pipe":17}],4:[function(r,f,s){var i=r("./context").Context,p=r("../date-reviver"),u=function(r,f){this.left=r,this.right=f,this.pipe="diff"};(u.prototype=new i).setResult=function(r){if(this.options.cloneDiffValues){var f="function"==typeof this.options.cloneDiffValues?this.options.cloneDiffValues:function(r){return JSON.parse(JSON.stringify(r),p)};"object"==typeof r[0]&&(r[0]=f(r[0])),"object"==typeof r[1]&&(r[1]=f(r[1]))}return i.prototype.setResult.apply(this,arguments)},s.DiffContext=u},{"../date-reviver":7,"./context":3}],5:[function(r,f,s){var i=r("./context").Context,p=function(r,f){this.left=r,this.delta=f,this.pipe="patch"};p.prototype=new i,s.PatchContext=p},{"./context":3}],6:[function(r,f,s){var i=r("./context").Context,p=function(r){this.delta=r,this.pipe="reverse"};p.prototype=new i,s.ReverseContext=p},{"./context":3}],7:[function(r,f,s){f.exports=function(r,f){var s;return"string"==typeof f&&(s=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d*))?(Z|([+\-])(\d{2}):(\d{2}))$/.exec(f))?new Date(Date.UTC(+s[1],+s[2]-1,+s[3],+s[4],+s[5],+s[6],+(s[7]||0))):f}},{}],8:[function(r,f,s){var i=r("./processor").Processor,p=r("./pipe").Pipe,u=r("./contexts/diff").DiffContext,h=r("./contexts/patch").PatchContext,l=r("./contexts/reverse").ReverseContext,a=r("./filters/trivial"),y=r("./filters/nested"),w=r("./filters/arrays"),b=r("./filters/dates"),j=r("./filters/texts"),_=function(r){this.processor=new i(r),this.processor.pipe(new p("diff").append(y.collectChildrenDiffFilter,a.diffFilter,b.diffFilter,j.diffFilter,y.objectsDiffFilter,w.diffFilter).shouldHaveResult()),this.processor.pipe(new p("patch").append(y.collectChildrenPatchFilter,w.collectChildrenPatchFilter,a.patchFilter,j.patchFilter,y.patchFilter,w.patchFilter).shouldHaveResult()),this.processor.pipe(new p("reverse").append(y.collectChildrenReverseFilter,w.collectChildrenReverseFilter,a.reverseFilter,j.reverseFilter,y.reverseFilter,w.reverseFilter).shouldHaveResult())};_.prototype.options=function(){return this.processor.options.apply(this.processor,arguments)},_.prototype.diff=function(r,f){return this.processor.process(new u(r,f))},_.prototype.patch=function(r,f){return this.processor.process(new h(r,f))},_.prototype.reverse=function(r){return this.processor.process(new l(r))},_.prototype.unpatch=function(r,f){return this.patch(r,this.reverse(f))},s.DiffPatcher=_},{"./contexts/diff":4,"./contexts/patch":5,"./contexts/reverse":6,"./filters/arrays":10,"./filters/dates":11,"./filters/nested":13,"./filters/texts":14,"./filters/trivial":15,"./pipe":17,"./processor":18}],9:[function(r,f,s){s.isBrowser="undefined"!=typeof window},{}],10:[function(r,f,s){var i=r("../contexts/diff").DiffContext,p=r("../contexts/patch").PatchContext,u=r("../contexts/reverse").ReverseContext,h=r("./lcs"),l="function"==typeof Array.isArray?Array.isArray:function(r){return r instanceof Array},a="function"==typeof Array.prototype.indexOf?function(r,f){return r.indexOf(f)}:function(r,f){for(var s=r.length,i=0;i<s;i++)if(r[i]===f)return i;return-1};function y(r,f,s,i,p){var u=r[s],h=f[i];if(u===h)return!0;if("object"!=typeof u||"object"!=typeof h)return!1;var l,a,y=p.objectHash;return y?("number"==typeof s?(p.hashCache1=p.hashCache1||[],void 0===(l=p.hashCache1[s])&&(p.hashCache1[s]=l=y(u,s))):l=y(u),void 0!==l&&("number"==typeof i?(p.hashCache2=p.hashCache2||[],void 0===(a=p.hashCache2[i])&&(p.hashCache2[i]=a=y(h,i))):a=y(h),void 0!==a&&l===a)):p.matchByPosition&&s===i}var w=function(r){if(r.leftIsArray){var f,s,p,u,l,w={objectHash:r.options&&r.options.objectHash,matchByPosition:r.options&&r.options.matchByPosition},b=0,j=0,_=r.left,g=r.right,E=_.length,N=g.length;for(E>0&&N>0&&!w.objectHash&&"boolean"!=typeof w.matchByPosition&&(w.matchByPosition=!function(r,f,s,i){for(var p=0;p<s;p++)for(var u=r[p],h=0;h<i;h++)if(u===f[h])return!0}(_,g,E,N));b<E&&b<N&&y(_,g,b,b,w);)f=b,u=new i(r.left[f],r.right[f]),r.push(u,f),b++;for(;j+b<E&&j+b<N&&y(_,g,E-1-j,N-1-j,w);)s=E-1-j,p=N-1-j,u=new i(r.left[s],r.right[p]),r.push(u,p),j++;if(b+j!==E)if(b+j!==N){delete w.hashCache1,delete w.hashCache2;var R=_.slice(b,E-j),P=g.slice(b,N-j),S=h.get(R,P,y,w),F=[];for(l=l||{_t:"a"},f=b;f<E-j;f++)a(S.indices1,f-b)<0&&(l["_"+f]=[_[f],0,0],F.push(f));var k=!0;r.options&&r.options.arrays&&!1===r.options.arrays.detectMove&&(k=!1);var $=!1;r.options&&r.options.arrays&&r.options.arrays.includeValueOnMove&&($=!0);var U=F.length;for(f=b;f<N-j;f++){var J=a(S.indices2,f-b);if(J<0){var V=!1;if(k&&U>0)for(var z=0;z<U;z++)if(y(R,P,(s=F[z])-b,f-b,w)){l["_"+s].splice(1,2,f,3),$||(l["_"+s][0]=""),p=f,u=new i(r.left[s],r.right[p]),r.push(u,p),F.splice(z,1),V=!0;break}V||(l[f]=[g[f]])}else s=S.indices1[J]+b,p=S.indices2[J]+b,u=new i(r.left[s],r.right[p]),r.push(u,p)}r.setResult(l).exit()}else{for(l=l||{_t:"a"},f=b;f<E-j;f++)l["_"+f]=[_[f],0,0];r.setResult(l).exit()}else{if(E===N)return void r.setResult(void 0).exit();for(l=l||{_t:"a"},f=b;f<N-j;f++)l[f]=[g[f]];r.setResult(l).exit()}}};w.filterName="arrays";var b=function(r,f){return r-f},j=function(r){return function(f,s){return f[r]-s[r]}},_=function(r){if(r.nested&&"a"===r.delta._t){var f,s,i=r.delta,u=r.left,h=[],l=[],a=[];for(f in i)if("_t"!==f)if("_"===f[0]){if(0!==i[f][2]&&3!==i[f][2])throw new Error("only removal or move can be applied at original array indices, invalid diff type: "+i[f][2]);h.push(parseInt(f.slice(1),10))}else 1===i[f].length?l.push({index:parseInt(f,10),value:i[f][0]}):a.push({index:parseInt(f,10),delta:i[f]});for(f=(h=h.sort(b)).length-1;f>=0;f--){var y=i["_"+(s=h[f])],w=u.splice(s,1)[0];3===y[2]&&l.push({index:y[1],value:w})}var _=(l=l.sort(j("index"))).length;for(f=0;f<_;f++){var g=l[f];u.splice(g.index,0,g.value)}var E,N=a.length;if(N>0)for(f=0;f<N;f++){var R=a[f];E=new p(r.left[R.index],R.delta),r.push(E,R.index)}r.children?r.exit():r.setResult(r.left).exit()}};_.filterName="arrays";var g=function(r){if(r&&r.children&&"a"===r.delta._t){for(var f,s=r.children.length,i=0;i<s;i++)f=r.children[i],r.left[f.childName]=f.result;r.setResult(r.left).exit()}};g.filterName="arraysCollectChildren";var E=function(r){if(r.nested){if("a"===r.delta._t){var f,s;for(f in r.delta)"_t"!==f&&(s=new u(r.delta[f]),r.push(s,f));r.exit()}}else 3===r.delta[2]&&(r.newName="_"+r.delta[1],r.setResult([r.delta[0],parseInt(r.childName.substr(1),10),3]).exit())};E.filterName="arrays";var N=function(r,f,s){if("string"==typeof f&&"_"===f[0])return parseInt(f.substr(1),10);if(l(s)&&0===s[2])return"_"+f;var i=+f;for(var p in r){var u=r[p];if(l(u))if(3===u[2]){var h=parseInt(p.substr(1),10),a=u[1];if(a===+f)return h;h<=i&&a>i?i++:h>=i&&a<i&&i--}else if(0===u[2]){parseInt(p.substr(1),10)<=i&&i++}else 1===u.length&&p<=i&&i--}return i},R=function(r){if(r&&r.children&&"a"===r.delta._t){for(var f,s=r.children.length,i={_t:"a"},p=0;p<s;p++){var u=(f=r.children[p]).newName;void 0===u&&(u=N(r.delta,f.childName,f.result)),i[u]!==f.result&&(i[u]=f.result)}r.setResult(i).exit()}};R.filterName="arraysCollectChildren",s.diffFilter=w,s.patchFilter=_,s.collectChildrenPatchFilter=g,s.reverseFilter=E,s.collectChildrenReverseFilter=R},{"../contexts/diff":4,"../contexts/patch":5,"../contexts/reverse":6,"./lcs":12}],11:[function(r,f,s){var i=function(r){r.left instanceof Date?(r.right instanceof Date?r.left.getTime()!==r.right.getTime()?r.setResult([r.left,r.right]):r.setResult(void 0):r.setResult([r.left,r.right]),r.exit()):r.right instanceof Date&&r.setResult([r.left,r.right]).exit()};i.filterName="dates",s.diffFilter=i},{}],12:[function(r,f,s){var i=function(r,f,s,i){return r[s]===f[i]},p=function(r,f,s,i,u,h){if(0===i||0===u)return{sequence:[],indices1:[],indices2:[]};if(r.match(f,s,i-1,u-1,h)){var l=p(r,f,s,i-1,u-1,h);return l.sequence.push(f[i-1]),l.indices1.push(i-1),l.indices2.push(u-1),l}return r[i][u-1]>r[i-1][u]?p(r,f,s,i,u-1,h):p(r,f,s,i-1,u,h)};s.get=function(r,f,s,u){var h=function(r,f,s,i){var p,u,h=r.length,l=f.length,a=[h+1];for(p=0;p<h+1;p++)for(a[p]=[l+1],u=0;u<l+1;u++)a[p][u]=0;for(a.match=s,p=1;p<h+1;p++)for(u=1;u<l+1;u++)s(r,f,p-1,u-1,i)?a[p][u]=a[p-1][u-1]+1:a[p][u]=Math.max(a[p-1][u],a[p][u-1]);return a}(r,f,s||i,u=u||{}),l=p(h,r,f,r.length,f.length,u);return"string"==typeof r&&"string"==typeof f&&(l.sequence=l.sequence.join("")),l}},{}],13:[function(r,f,s){var i=r("../contexts/diff").DiffContext,p=r("../contexts/patch").PatchContext,u=r("../contexts/reverse").ReverseContext,h=function(r){if(r&&r.children){for(var f,s=r.children.length,i=r.result,p=0;p<s;p++)void 0!==(f=r.children[p]).result&&((i=i||{})[f.childName]=f.result);i&&r.leftIsArray&&(i._t="a"),r.setResult(i).exit()}};h.filterName="collectChildren";var l=function(r){if(!r.leftIsArray&&"object"===r.leftType){var f,s,p=r.options.propertyFilter;for(f in r.left)Object.prototype.hasOwnProperty.call(r.left,f)&&(p&&!p(f,r)||(s=new i(r.left[f],r.right[f]),r.push(s,f)));for(f in r.right)Object.prototype.hasOwnProperty.call(r.right,f)&&(p&&!p(f,r)||void 0===r.left[f]&&(s=new i(void 0,r.right[f]),r.push(s,f)));r.children&&0!==r.children.length?r.exit():r.setResult(void 0).exit()}};l.filterName="objects";var a=function(r){if(r.nested&&!r.delta._t){var f,s;for(f in r.delta)s=new p(r.left[f],r.delta[f]),r.push(s,f);r.exit()}};a.filterName="objects";var y=function(r){if(r&&r.children&&!r.delta._t){for(var f,s=r.children.length,i=0;i<s;i++)f=r.children[i],Object.prototype.hasOwnProperty.call(r.left,f.childName)&&void 0===f.result?delete r.left[f.childName]:r.left[f.childName]!==f.result&&(r.left[f.childName]=f.result);r.setResult(r.left).exit()}};y.filterName="collectChildren";var w=function(r){if(r.nested&&!r.delta._t){var f,s;for(f in r.delta)s=new u(r.delta[f]),r.push(s,f);r.exit()}};w.filterName="objects";var b=function(r){if(r&&r.children&&!r.delta._t){for(var f,s=r.children.length,i={},p=0;p<s;p++)i[(f=r.children[p]).childName]!==f.result&&(i[f.childName]=f.result);r.setResult(i).exit()}};b.filterName="collectChildren",s.collectChildrenDiffFilter=h,s.objectsDiffFilter=l,s.patchFilter=a,s.collectChildrenPatchFilter=y,s.reverseFilter=w,s.collectChildrenReverseFilter=b},{"../contexts/diff":4,"../contexts/patch":5,"../contexts/reverse":6}],14:[function(r,f,s){var i=null,p=function(f){if(!i){var s;if("undefined"!=typeof diff_match_patch)s="function"==typeof diff_match_patch?new diff_match_patch:new diff_match_patch.diff_match_patch;else if("function"==typeof r)try{var p=r("../../public/external/diff_match_patch_uncompressed");s=new p.diff_match_patch}catch(r){s=null}if(!s){if(!f)return null;var u=new Error("text diff_match_patch library not found");throw u.diff_match_patch_not_found=!0,u}i={diff:function(r,f){return s.patch_toText(s.patch_make(r,f))},patch:function(r,f){for(var i=s.patch_apply(s.patch_fromText(f),r),p=0;p<i[1].length;p++){if(!i[1][p])new Error("text patch failed").textPatchFailed=!0}return i[0]}}}return i},u=function(r){if("string"===r.leftType){var f=r.options&&r.options.textDiff&&r.options.textDiff.minLength||60;if(r.left.length<f||r.right.length<f)r.setResult([r.left,r.right]).exit();else{var s=p();if(s){var i=s.diff;r.setResult([i(r.left,r.right),0,2]).exit()}else r.setResult([r.left,r.right]).exit()}}};u.filterName="texts";var h=function(r){if(!r.nested&&2===r.delta[2]){var f=p(!0).patch;r.setResult(f(r.left,r.delta[0])).exit()}};h.filterName="texts";var l=function(r){var f,s,i,p,u,h=null,l=/^@@ +\-(\d+),(\d+) +\+(\d+),(\d+) +@@$/;for(f=0,s=(i=r.split("\n")).length;f<s;f++){var a=(p=i[f]).slice(0,1);"@"===a?(h=l.exec(p),null,null,i[f]="@@ -"+h[3]+","+h[4]+" +"+h[1]+","+h[2]+" @@"):"+"===a?(f,i[f]="-"+i[f].slice(1),"+"===i[f-1].slice(0,1)&&(u=i[f],i[f]=i[f-1],i[f-1]=u)):"-"===a&&(f,i[f]="+"+i[f].slice(1))}return i.join("\n")},a=function(r){r.nested||2===r.delta[2]&&r.setResult([l(r.delta[0]),0,2]).exit()};a.filterName="texts",s.diffFilter=u,s.patchFilter=h,s.reverseFilter=a},{}],15:[function(r,f,s){var i="function"==typeof Array.isArray?Array.isArray:function(r){return r instanceof Array},p=function(r){if(r.left!==r.right)if(void 0!==r.left)if(void 0!==r.right){if("function"==typeof r.left||"function"==typeof r.right)throw new Error("functions are not supported");r.leftType=null===r.left?"null":typeof r.left,r.rightType=null===r.right?"null":typeof r.right,r.leftType===r.rightType&&"boolean"!==r.leftType&&"number"!==r.leftType?("object"===r.leftType&&(r.leftIsArray=i(r.left)),"object"===r.rightType&&(r.rightIsArray=i(r.right)),r.leftIsArray===r.rightIsArray||r.setResult([r.left,r.right]).exit()):r.setResult([r.left,r.right]).exit()}else r.setResult([r.left,0,0]).exit();else{if("function"==typeof r.right)throw new Error("functions are not supported");r.setResult([r.right]).exit()}else r.setResult(void 0).exit()};p.filterName="trivial";var u=function(r){void 0!==r.delta?(r.nested=!i(r.delta),r.nested||(1!==r.delta.length?2!==r.delta.length?3!==r.delta.length||0!==r.delta[2]||r.setResult(void 0).exit():r.setResult(r.delta[1]).exit():r.setResult(r.delta[0]).exit())):r.setResult(r.left).exit()};u.filterName="trivial";var h=function(r){void 0!==r.delta?(r.nested=!i(r.delta),r.nested||(1!==r.delta.length?2!==r.delta.length?3!==r.delta.length||0!==r.delta[2]||r.setResult([r.delta[0]]).exit():r.setResult([r.delta[1],r.delta[0]]).exit():r.setResult([r.delta[0],0,0]).exit())):r.setResult(r.delta).exit()};h.filterName="trivial",s.diffFilter=p,s.patchFilter=u,s.reverseFilter=h},{}],16:[function(r,f,s){var i,p=r("./environment"),u=r("./diffpatcher").DiffPatcher;if(s.DiffPatcher=u,s.create=function(r){return new u(r)},s.dateReviver=r("./date-reviver"),s.diff=function(){return i||(i=new u),i.diff.apply(i,arguments)},s.patch=function(){return i||(i=new u),i.patch.apply(i,arguments)},s.unpatch=function(){return i||(i=new u),i.unpatch.apply(i,arguments)},s.reverse=function(){return i||(i=new u),i.reverse.apply(i,arguments)},p.isBrowser)s.homepage="{{package-homepage}}",s.version="{{package-version}}";else{var h=r("../package.json");s.homepage=h.homepage,s.version=h.version;var l=r("./formatters");s.formatters=l,s.console=l.console}},{"./date-reviver":7,"./diffpatcher":8,"./environment":9}],17:[function(r,f,s){var i=function(r){this.name=r,this.filters=[]};i.prototype.process=function(r){if(!this.processor)throw new Error("add this pipe to a processor before using it");for(var f=this.debug,s=this.filters.length,i=r,p=0;p<s;p++){var u=this.filters[p];if(f&&this.log("filter: "+u.filterName),u(i),"object"==typeof i&&i.exiting){i.exiting=!1;break}}!i.next&&this.resultCheck&&this.resultCheck(i)},i.prototype.log=function(r){console.log("[jsondiffpatch] "+this.name+" pipe, "+r)},i.prototype.append=function(){return this.filters.push.apply(this.filters,arguments),this},i.prototype.prepend=function(){return this.filters.unshift.apply(this.filters,arguments),this},i.prototype.indexOf=function(r){if(!r)throw new Error("a filter name is required");for(var f=0;f<this.filters.length;f++){if(this.filters[f].filterName===r)return f}throw new Error("filter not found: "+r)},i.prototype.list=function(){for(var r=[],f=0;f<this.filters.length;f++){var s=this.filters[f];r.push(s.filterName)}return r},i.prototype.after=function(r){var f=this.indexOf(r),s=Array.prototype.slice.call(arguments,1);if(!s.length)throw new Error("a filter is required");return s.unshift(f+1,0),Array.prototype.splice.apply(this.filters,s),this},i.prototype.before=function(r){var f=this.indexOf(r),s=Array.prototype.slice.call(arguments,1);if(!s.length)throw new Error("a filter is required");return s.unshift(f,0),Array.prototype.splice.apply(this.filters,s),this},i.prototype.clear=function(){return this.filters.length=0,this},i.prototype.shouldHaveResult=function(r){if(!1!==r){if(!this.resultCheck){var f=this;return this.resultCheck=function(r){if(!r.hasResult){console.log(r);var s=new Error(f.name+" failed");throw s.noResult=!0,s}},this}}else this.resultCheck=null},s.Pipe=i},{}],18:[function(r,f,s){var i=function(r){this.selfOptions=r||{},this.pipes={}};i.prototype.options=function(r){return r&&(this.selfOptions=r),this.selfOptions},i.prototype.pipe=function(r,f){if("string"==typeof r){if(void 0===f)return this.pipes[r];this.pipes[r]=f}if(r&&r.name){if((f=r).processor===this)return f;this.pipes[f.name]=f}return f.processor=this,f},i.prototype.process=function(r,f){var s=r;s.options=this.options();for(var i,p,u=f||r.pipe||"default";u;)void 0!==s.nextAfterChildren&&(s.next=s.nextAfterChildren,s.nextAfterChildren=null),"string"==typeof u&&(u=this.pipe(u)),u.process(s),p=s,i=u,u=null,s&&s.next&&(s=s.next,u=p.nextPipe||s.pipe||i);return s.hasResult?s.result:void 0},s.Processor=i},{}],19:[function(r,f,s){var i=r("lodash._basecopy"),p=r("lodash.keys");f.exports=function(r,f){return null==f?r:i(f,p(f),r)}},{"lodash._basecopy":20,"lodash.keys":35}],20:[function(r,f,s){f.exports=function(r,f,s){s||(s={});for(var i=-1,p=f.length;++i<p;){var u=f[i];s[u]=r[u]}return s}},{}],21:[function(r,f,s){function i(r){return r}f.exports=function(r,f,s){if("function"!=typeof r)return i;if(void 0===f)return r;switch(s){case 1:return function(s){return r.call(f,s)};case 3:return function(s,i,p){return r.call(f,s,i,p)};case 4:return function(s,i,p,u){return r.call(f,s,i,p,u)};case 5:return function(s,i,p,u,h){return r.call(f,s,i,p,u,h)}}return function(){return r.apply(f,arguments)}}},{}],22:[function(r,f,s){var i=r("lodash._bindcallback"),p=r("lodash._isiterateecall"),u=r("lodash.restparam");f.exports=function(r){return u(function(f,s){var u=-1,h=null==f?0:s.length,l=h>2?s[h-2]:void 0,a=h>2?s[2]:void 0,y=h>1?s[h-1]:void 0;for("function"==typeof l?(l=i(l,y,5),h-=2):h-=(l="function"==typeof y?y:void 0)?1:0,a&&p(s[0],s[1],a)&&(l=h<3?void 0:l,h=1);++u<h;){var w=s[u];w&&r(f,w,l)}return f})}},{"lodash._bindcallback":21,"lodash._isiterateecall":25,"lodash.restparam":36}],23:[function(r,f,s){var i=r("lodash._root"),p=1,u=2,h=4,l=8,a=16,y=32,w=64,b=128,j=512,_="Expected a function",g=1/0,E=9007199254740991,N=1.7976931348623157e308,R=NaN,P="__lodash_placeholder__",S="[object Function]",F="[object GeneratorFunction]",k=/^\s+|\s+$/g,$=/^[-+]0x[0-9a-f]+$/i,U=/^0b[01]+$/i,J=/^0o[0-7]+$/i,V=/^(?:0|[1-9]\d*)$/,z=parseInt;function Q(r,f,s){switch(s.length){case 0:return r.call(f);case 1:return r.call(f,s[0]);case 2:return r.call(f,s[0],s[1]);case 3:return r.call(f,s[0],s[1],s[2])}return r.apply(f,s)}function C(r,f){return r="number"==typeof r||V.test(r)?+r:-1,f=null==f?E:f,r>-1&&r%1==0&&r<f}function K(r,f){for(var s=-1,i=r.length,p=-1,u=[];++s<i;)r[s]===f&&(r[s]=P,u[++p]=s);return u}var Z=Object.prototype.toString,X=Math.max,B=Math.min,D=function(){function r(){}return function(f){if(T(f)){r.prototype=f;var s=new r;r.prototype=void 0}return s||{}}}();function W(r,f){var s=-1,i=r.length;for(f||(f=Array(i));++s<i;)f[s]=r[s];return f}function Y(r){return function(){var f=arguments;switch(f.length){case 0:return new r;case 1:return new r(f[0]);case 2:return new r(f[0],f[1]);case 3:return new r(f[0],f[1],f[2]);case 4:return new r(f[0],f[1],f[2],f[3]);case 5:return new r(f[0],f[1],f[2],f[3],f[4]);case 6:return new r(f[0],f[1],f[2],f[3],f[4],f[5]);case 7:return new r(f[0],f[1],f[2],f[3],f[4],f[5],f[6])}var s=D(r.prototype),i=r.apply(s,f);return T(i)?i:s}}function v(r,f,s,h,y,w,_,g,E,N){var R=f&b,P=f&p,S=f&u,F=f&l,k=f&a,$=f&j,U=S?void 0:Y(r);return function p(){for(var u=arguments.length,l=u,a=Array(u);l--;)a[l]=arguments[l];if(h&&(a=function(r,f,s){for(var i=s.length,p=-1,u=X(r.length-i,0),h=-1,l=f.length,a=Array(l+u);++h<l;)a[h]=f[h];for(;++p<i;)a[s[p]]=r[p];for(;u--;)a[h++]=r[p++];return a}(a,h,y)),w&&(a=function(r,f,s){for(var i=-1,p=s.length,u=-1,h=X(r.length-p,0),l=-1,a=f.length,y=Array(h+a);++u<h;)y[u]=r[u];for(var w=u;++l<a;)y[w+l]=f[l];for(;++i<p;)y[w+s[i]]=r[u++];return y}(a,w,_)),F||k){var b=p.placeholder,j=K(a,b);if((u-=j.length)<N)return G(r,f,v,b,s,a,j,g,E,N-u)}var J=P?s:this,V=S?J[r]:r;return g?a=function(r,f){for(var s=r.length,i=B(f.length,s),p=W(r);i--;){var u=f[i];r[i]=C(u,s)?p[u]:void 0}return r}(a,g):$&&a.length>1&&a.reverse(),R&&E<a.length&&(a.length=E),this&&this!==i&&this instanceof p&&(V=U||Y(V)),V.apply(J,a)}}function G(r,f,s,i,a,b,j,_,g,E){var N=f&l,R=_?W(_):void 0;f|=N?y:w,(f&=~(N?w:y))&h||(f&=~(p|u));var P=s(r,f,a,N?b:void 0,N?j:void 0,N?void 0:b,N?void 0:j,R,g,E);return P.placeholder=i,P}function T(r){var f=typeof r;return!!r&&("object"==f||"function"==f)}function q(r){if(!r)return 0===r?r:0;if((r=function(r){if(T(r)){var f=function(r){var f=T(r)?Z.call(r):"";return f==S||f==F}(r.valueOf)?r.valueOf():r;r=T(f)?f+"":f}if("string"!=typeof r)return 0===r?r:+r;r=r.replace(k,"");var s=U.test(r);return s||J.test(r)?z(r.slice(2),s?2:8):$.test(r)?R:+r}(r))===g||r===-g)return(r<0?-1:1)*N;var f=r%1;return r==r?f?r-f:r:0}f.exports=function(r,f,s,h,b,j,g,E){var N=f&u;if(!N&&"function"!=typeof r)throw new TypeError(_);var R=h?h.length:0;if(R||(f&=~(y|w),h=b=void 0),g=void 0===g?g:X(q(g),0),E=void 0===E?E:q(E),R-=b?b.length:0,f&w){var P=h,S=b;h=b=void 0}var F=[r,f,s,h,b,P,S,j,g,E];if(r=F[0],f=F[1],s=F[2],h=F[3],b=F[4],!(E=F[9]=null==F[9]?N?0:r.length:X(F[9]-R,0))&&f&(l|a)&&(f&=~(l|a)),f&&f!=p)k=f==l||f==a?function(r,f,s){var p=Y(r);return function u(){for(var h=arguments.length,l=h,a=Array(h),y=this&&this!==i&&this instanceof u?p:r,w=u.placeholder;l--;)a[l]=arguments[l];var b=h<3&&a[0]!==w&&a[h-1]!==w?[]:K(a,w);return(h-=b.length)<s?G(r,f,v,w,void 0,a,b,void 0,void 0,s-h):Q(y,this,a)}}(r,f,E):f!=y&&f!=(p|y)||b.length?v.apply(void 0,F):function(r,f,s,u){var h=f&p,l=Y(r);return function f(){for(var p=-1,a=arguments.length,y=-1,w=u.length,b=Array(w+a),j=this&&this!==i&&this instanceof f?l:r;++y<w;)b[y]=u[y];for(;a--;)b[y++]=arguments[++p];return Q(j,h?s:this,b)}}(r,f,s,h);else var k=function(r,f,s){var u=f&p,h=Y(r);return function f(){return(this&&this!==i&&this instanceof f?h:r).apply(u?s:this,arguments)}}(r,f,s);return k}},{"lodash._root":27}],24:[function(r,f,s){var i="[object Function]",p=/^\[object .+?Constructor\]$/;var u=Object.prototype,h=Function.prototype.toString,l=u.hasOwnProperty,a=u.toString,y=RegExp("^"+h.call(l).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");f.exports=function(r,f){var s=null==r?void 0:r[f];return function(r){return null!=r&&(function(r){return function(r){var f=typeof r;return!!r&&("object"==f||"function"==f)}(r)&&a.call(r)==i}(r)?y.test(h.call(r)):function(r){return!!r&&"object"==typeof r}(r)&&p.test(r))}(s)?s:void 0}},{}],25:[function(r,f,s){var i=/^\d+$/,p=9007199254740991;var u,h=(u="length",function(r){return null==r?void 0:r[u]});function l(r){return null!=r&&function(r){return"number"==typeof r&&r>-1&&r%1==0&&r<=p}(h(r))}f.exports=function(r,f,s){if(!function(r){var f=typeof r;return!!r&&("object"==f||"function"==f)}(s))return!1;var u=typeof f;if("number"==u?l(s)&&function(r,f){return r="number"==typeof r||i.test(r)?+r:-1,f=null==f?p:f,r>-1&&r%1==0&&r<f}(f,s.length):"string"==u&&f in s){var h=s[f];return r==r?r===h:h!=h}return!1}},{}],26:[function(r,f,s){var i="__lodash_placeholder__";f.exports=function(r,f){for(var s=-1,p=r.length,u=-1,h=[];++s<p;)r[s]===f&&(r[s]=i,h[++u]=s);return h}},{}],27:[function(r,f,s){(function(r){var i={function:!0,object:!0},p=i[typeof s]&&s&&!s.nodeType?s:void 0,u=i[typeof f]&&f&&!f.nodeType?f:void 0,h=b(p&&u&&"object"==typeof r&&r),l=b(i[typeof self]&&self),a=b(i[typeof window]&&window),y=b(i[typeof this]&&this),w=h||a!==(y&&y.window)&&a||l||y||Function("return this")();function b(r){return r&&r.Object===Object?r:null}f.exports=w}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],28:[function(r,f,s){var i=r("lodash._baseassign"),p=r("lodash._createassigner"),u=r("lodash.keys");var h=p(function(r,f,s){return s?function(r,f,s){for(var i=-1,p=u(f),h=p.length;++i<h;){var l=p[i],a=r[l],y=s(a,f[l],l,r,f);(y==y?y===a:a!=a)&&(void 0!==a||l in r)||(r[l]=y)}return r}(r,f,s):i(r,f)});f.exports=h},{"lodash._baseassign":19,"lodash._createassigner":22,"lodash.keys":35}],29:[function(r,f,s){var i=r("lodash._createwrapper"),p=r("lodash._replaceholders"),u=r("lodash.restparam"),h=u(function(r,f,s){var u=1;if(s.length){var l=p(s,h.placeholder);u|=32}return i(r,u,f,s,l)});h.placeholder={},f.exports=h},{"lodash._createwrapper":23,"lodash._replaceholders":26,"lodash.restparam":36}],30:[function(r,f,s){var i=9007199254740991,p="[object Arguments]",u="[object Function]",h="[object GeneratorFunction]",l=Object.prototype,a=l.hasOwnProperty,y=l.toString,w=l.propertyIsEnumerable;f.exports=function(r){return function(r){return function(r){return!!r&&"object"==typeof r}(r)&&function(r){return null!=r&&function(r){return"number"==typeof r&&r>-1&&r%1==0&&r<=i}(r.length)&&!function(r){var f=function(r){var f=typeof r;return!!r&&("object"==f||"function"==f)}(r)?y.call(r):"";return f==u||f==h}(r)}(r)}(r)&&a.call(r,"callee")&&(!w.call(r,"callee")||y.call(r)==p)}},{}],31:[function(r,f,s){var i="[object Function]",p=/^\[object .+?Constructor\]$/;function u(r){return!!r&&"object"==typeof r}var h,l,a,y=Object.prototype,w=Function.prototype.toString,b=y.hasOwnProperty,j=y.toString,_=RegExp("^"+w.call(b).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),g=(h=Array,l="isArray",function(r){return null!=r&&(function(r){return function(r){var f=typeof r;return!!r&&("object"==f||"function"==f)}(r)&&j.call(r)==i}(r)?_.test(w.call(r)):u(r)&&p.test(r))}(a=null==h?void 0:h[l])?a:void 0),E=9007199254740991;var N=g||function(r){return u(r)&&function(r){return"number"==typeof r&&r>-1&&r%1==0&&r<=E}(r.length)&&"[object Array]"==j.call(r)};f.exports=N},{}],32:[function(r,f,s){var i=r("lodash.isarguments"),p=r("lodash.isarray"),u=r("lodash.isfunction"),h=r("lodash.isstring"),l=r("lodash.keys");var a=9007199254740991;var y,w=(y="length",function(r){return null==r?void 0:r[y]});function b(r){return null!=r&&function(r){return"number"==typeof r&&r>-1&&r%1==0&&r<=a}(w(r))}f.exports=function(r){return null==r||(b(r)&&(p(r)||h(r)||i(r)||function(r){return!!r&&"object"==typeof r}(r)&&u(r.splice))?!r.length:!l(r).length)}},{"lodash.isarguments":30,"lodash.isarray":31,"lodash.isfunction":33,"lodash.isstring":34,"lodash.keys":35}],33:[function(r,f,s){(function(r){var s="[object AsyncFunction]",i="[object Function]",p="[object GeneratorFunction]",u="[object Null]",h="[object Proxy]",l="[object Undefined]",a="object"==typeof r&&r&&r.Object===Object&&r,y="object"==typeof self&&self&&self.Object===Object&&self,w=a||y||Function("return this")(),b=Object.prototype,j=b.hasOwnProperty,_=b.toString,g=w.Symbol,E=g?g.toStringTag:void 0;function N(r){return null==r?void 0===r?l:u:E&&E in Object(r)?function(r){var f=j.call(r,E),s=r[E];try{r[E]=void 0;var i=!0}catch(r){}var p=_.call(r);i&&(f?r[E]=s:delete r[E]);return p}(r):function(r){return _.call(r)}(r)}f.exports=function(r){if(!function(r){var f=typeof r;return null!=r&&("object"==f||"function"==f)}(r))return!1;var f=N(r);return f==i||f==p||f==s||f==h}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],34:[function(r,f,s){var i="[object String]";var p=Object.prototype.toString;f.exports=function(r){return"string"==typeof r||function(r){return!!r&&"object"==typeof r}(r)&&p.call(r)==i}},{}],35:[function(r,f,s){var i=r("lodash._getnative"),p=r("lodash.isarguments"),u=r("lodash.isarray"),h=/^\d+$/,l=Object.prototype.hasOwnProperty,a=i(Object,"keys"),y=9007199254740991;var w,b=(w="length",function(r){return null==r?void 0:r[w]});function j(r,f){return r="number"==typeof r||h.test(r)?+r:-1,f=null==f?y:f,r>-1&&r%1==0&&r<f}function _(r){return"number"==typeof r&&r>-1&&r%1==0&&r<=y}function g(r){for(var f=function(r){if(null==r)return[];E(r)||(r=Object(r));var f=r.length;f=f&&_(f)&&(u(r)||p(r))&&f||0;var s=r.constructor,i=-1,h="function"==typeof s&&s.prototype===r,a=Array(f),y=f>0;for(;++i<f;)a[i]=i+"";for(var w in r)y&&j(w,f)||"constructor"==w&&(h||!l.call(r,w))||a.push(w);return a}(r),s=f.length,i=s&&r.length,h=!!i&&_(i)&&(u(r)||p(r)),a=-1,y=[];++a<s;){var w=f[a];(h&&j(w,i)||l.call(r,w))&&y.push(w)}return y}function E(r){var f=typeof r;return!!r&&("object"==f||"function"==f)}var N=a?function(r){var f,s=null==r?void 0:r.constructor;return"function"==typeof s&&s.prototype===r||"function"!=typeof r&&(null!=(f=r)&&_(b(f)))?g(r):E(r)?a(r):[]}:g;f.exports=N},{"lodash._getnative":24,"lodash.isarguments":30,"lodash.isarray":31}],36:[function(r,f,s){var i="Expected a function",p=Math.max;f.exports=function(r,f){if("function"!=typeof r)throw new TypeError(i);return f=p(void 0===f?r.length-1:+f||0,0),function(){for(var s=arguments,i=-1,u=p(s.length-f,0),h=Array(u);++i<u;)h[i]=s[f+i];switch(f){case 0:return r.call(this,h);case 1:return r.call(this,s[0],h);case 2:return r.call(this,s[0],s[1],h)}var l=Array(f+1);for(i=-1;++i<f;)l[i]=s[i];return l[f]=h,r.apply(this,l)}}},{}],37:[function(r,f,s){var i=function(r){this.cache=r||{}};i.prototype.getData=function(r,f){this.cache[r]||(this.cache[r]={}),f(null,this.cache[r])},i.prototype.storeData=function(r,f,s){this.cache[r]=f,s&&s(null)},f.exports=i},{}],38:[function(r,f,s){var i,p=r("lodash.assign"),u=r("lodash.bind"),h=r("lodash.isempty"),l=r("events").EventEmitter,a=r("jsondiffpatch"),y=r("./commands"),w=r("./utils");((i=function(r,f,s){if(!r)throw new Error("No socket specified");f||(f=""),s||(s={}),this.socket=r,this.room=f,this.syncing=!1,this.initialized=!1,this.scheduled=!1,this.doc={localVersion:0,serverVersion:0,shadow:{},localCopy:{},edits:[]},s=p({objectHash:function(r){return r.id||r._id||JSON.stringify(r)}},s),this.jsondiffpatch=a.create(s),l.call(this);var i,h=["_onConnected","syncWithServer","applyServerEdit","applyServerEdits","schedule","onRemoteUpdate"];for(var y in h)this[i=h[y]]=u(this[i],this)}).prototype=new l).getData=function(){return this.doc.localCopy},i.prototype.initialize=function(){this.syncing=!0,this.socket.emit(y.join,this.room,this._onConnected)},i.prototype._onConnected=function(r){this.syncing=!1,this.initialized=!0,this.doc.shadow=w.deepCopy(r),this.doc.localCopy=r,this.doc.serverVersion=0,this.socket.on(y.remoteUpdateIncoming,this.onRemoteUpdate),this.emit("connected")},i.prototype.onRemoteUpdate=function(r){this.socket.id!==r&&this.schedule()},i.prototype.schedule=function(){this.scheduled||(this.scheduled=!0,this.syncWithServer())},i.prototype.sync=function(){this.schedule()},i.prototype.syncWithServer=function(){if(this.syncing||!this.initialized)return!1;this.scheduled&&(this.scheduled=!1),this.syncing=!0;var r=this.createDiff(this.doc.shadow,this.doc.localCopy),f=this.doc.localVersion;h(r)||(this.doc.edits.push(this.createDiffMessage(r,f)),this.doc.localVersion++);var s=this.createEditMessage(f);return this.applyPatchTo(this.doc.shadow,w.deepCopy(r)),this.sendEdits(s),!0},i.prototype.createDiff=function(r,f){return this.jsondiffpatch.diff(r,f)},i.prototype.applyPatchTo=function(r,f){this.jsondiffpatch.patch(r,f)},i.prototype.createDiffMessage=function(r,f){return{serverVersion:this.doc.serverVersion,localVersion:f,diff:r}},i.prototype.createEditMessage=function(r){return{room:this.room,edits:this.doc.edits,localVersion:r,serverVersion:this.doc.serverVersion}},i.prototype.sendEdits=function(r){this.socket.emit(y.syncWithServer,r,this.applyServerEdits)},i.prototype.applyServerEdits=function(r){r&&r.localVersion===this.doc.localVersion?(this.doc.edits=[],r.edits.forEach(this.applyServerEdit)):this.emit("error","REJECTED_PATCH"),this.syncing=!1,this.emit("synced"),this.scheduled&&this.syncWithServer()},i.prototype.applyServerEdit=function(r){return r.localVersion===this.doc.localVersion&&r.serverVersion===this.doc.serverVersion&&(h(r.diff)||(this.applyPatchTo(this.doc.shadow,r.diff),this.doc.serverVersion++,this.applyPatchTo(this.doc.localCopy,w.deepCopy(r.diff))),!0)},f.exports=i},{"./commands":39,"./utils":41,events:1,jsondiffpatch:16,"lodash.assign":28,"lodash.bind":29,"lodash.isempty":32}],39:[function(r,f,s){f.exports={join:"diffsync-join",syncWithServer:"diffsync-send-edit",remoteUpdateIncoming:"diffsync-updated-doc",error:"diffsync-error"}},{}],40:[function(r,f,s){var i,p=r("lodash.assign"),u=r("lodash.bind"),h=r("lodash.isempty"),l=r("jsondiffpatch"),a=r("./commands"),y=r("./utils");(i=function(r,f,s){if(!r||!f)throw new Error("Need to specify an adapter and a transport");s||(s={}),this.adapter=r,this.transport=f,this.data={},this.requests={},this.saveRequests={},this.saveQueue={},this.trackConnection=u(this.trackConnection,this),s=p({objectHash:function(r){return r.id||r._id||JSON.stringify(r)}},s),this.jsondiffpatch=l.create(s),this.transport.on("connection",this.trackConnection)}).prototype.trackConnection=function(r){r.on(a.join,this.joinConnection.bind(this,r)),r.on(a.syncWithServer,this.receiveEdit.bind(this,r))},i.prototype.joinConnection=function(r,f,s){this.getData(f,function(i,p){r.join(f),p.clientVersions[r.id]={backup:{doc:y.deepCopy(p.serverCopy),serverVersion:0},shadow:{doc:y.deepCopy(p.serverCopy),serverVersion:0,localVersion:0},edits:[]},s(p.serverCopy)})},i.prototype.getData=function(r,f){var s=this.data[r],i=this.data,p=this.requests;s?f(null,s):p[r]?p[r]=!0:(p[r]=!0,this.adapter.getData(r,function(s,u){i[r]={registeredSockets:[],clientVersions:{},serverCopy:u},p[r]=!1,f(null,i[r])}))},i.prototype.receiveEdit=function(r,f,s){this.getData(f.room,function(i,p){var u=p.clientVersions[r.id];!i&&u?(f.serverVersion===u.shadow.serverVersion&&(u.edits=[]),f.edits.forEach(function(r){r.serverVersion===u.shadow.serverVersion&&r.localVersion===u.shadow.localVersion?(u.backup.doc=y.deepCopy(u.shadow.doc),this.jsondiffpatch.patch(u.shadow.doc,y.deepCopy(r.diff)),this.jsondiffpatch.patch(p.serverCopy,y.deepCopy(r.diff)),h(r.diff)||u.shadow.localVersion++):console.log("error","patch rejected!!",r.serverVersion,"->",u.shadow.serverVersion,":",r.localVersion,"->",u.shadow.localVersion)}.bind(this)),this.saveSnapshot(f.room),f.edits.length>0&&this.transport.to(f.room).emit(a.remoteUpdateIncoming,r.id),this.sendServerChanges(p,u,s)):r.emit(a.error,"Need to re-connect!")}.bind(this))},i.prototype.saveSnapshot=function(r){var f=!this.saveRequests[r],s=function(){var f=!0===this.saveQueue[r];this.saveRequests[r]=!1,f&&(this.saveQueue[r]=!1,this.saveSnapshot(r))}.bind(this);f?(this.saveRequests[r]=!0,this.getData(r,function(f,i){!f&&i?this.adapter.storeData(r,i.serverCopy,s):s()}.bind(this))):this.saveQueue[r]=!0},i.prototype.sendServerChanges=function(r,f,s){var i=this.jsondiffpatch.diff(f.shadow.doc,r.serverCopy),p=f.shadow.serverVersion;h(i)||(f.edits.push({serverVersion:p,localVersion:f.shadow.localVersion,diff:i}),f.shadow.serverVersion++,this.jsondiffpatch.patch(f.shadow.doc,y.deepCopy(i))),s({localVersion:f.shadow.localVersion,serverVersion:p,edits:f.edits})},f.exports=i},{"./commands":39,"./utils":41,jsondiffpatch:16,"lodash.assign":28,"lodash.bind":29,"lodash.isempty":32}],41:[function(r,f,s){f.exports={deepCopy:function(r){return null==r?r:JSON.parse(JSON.stringify(r))}}},{}]},{},[2])(2)});